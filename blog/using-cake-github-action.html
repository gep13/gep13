
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Gary Ewan Park - Using Cake GitHub Action</title>
        <meta name="description" content="Ramblings and Ponderings of a Microsoft Fan Boy..." />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Gary Ewan Park" href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Gary Ewan Park" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Gary Ewan Park" />
        <meta name="msapplication-tooltip" content="Gary Ewan Park" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Gary Ewan Park - Using Cake GitHub Action" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://www.gep13.co.uk/blog/using-cake-github-action" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/please-compressed.js"></script>
        <script src="/assets/js/background-check.min.js"></script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->
        
        


        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Gary Ewan Park</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                <li><a href="/about">About</a></li>
<li><a href="/projects">Projects</a></li>
<li><a href="/talks">Talks</a></li>
<li><a href="/blog">Archive</a></li>
<li><a href="/contact">Contact</a></li>
<li><a href="/tags">Tags</a></li> 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Using Cake GitHub Action</h1>
    <div class="meta">        
Published on 15 December 2018<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/actions" class="btn btn-default btn-xs">actions</a>
                    <a role="button" href="/tags/automation" class="btn btn-default btn-xs">automation</a>
                    <a role="button" href="/tags/cake" class="btn btn-default btn-xs">cake</a>
                    <a role="button" href="/tags/github" class="btn btn-default btn-xs">github</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<p>In <a href="https://www.gep13.co.uk/blog/getting-started-with-github-actions">yesterdays blog post</a> I described how I had been able to create a custom GitHub Action to execute a target from a  <a href="https://cakebuild.net/">Cake</a> script.  To follow up on that, I thought it would be good to show how you can actually make use of this custom action, to achieve something useful in terms of a GitHub Action.</p>
<h2 id="what-are-we-going-to-do">What are we going to do?</h2>
<p>Almost exclusively on the Open Source projects that I work on, I use GitHub Milestones to collect the Issues/Pull Requests that are going to be included in any given release.  Once everything is ready, I release the &quot;bits&quot; of the project, and then I close the Milestone.  Wouldn't it be good if the act of closing a Milestone were to trigger a notification to Twitter, to let people know that the release is ready.  I think so...</p>
<h2 id="milestone-event">Milestone event</h2>
<p>Of the <a href="https://developer.github.com/actions/creating-workflows/workflow-configuration-options/#events-supported-in-workflow-files">28 events</a> that can trigger the workflow of a GitHub Action, one of them is the <a href="https://developer.github.com/v3/activity/events/types/#milestoneevent">milestone event</a>, which will trigger:</p>
<blockquote class="blockquote">
<p>Any time a milestone is created, closed, opened, edited, or deleted.</p>
</blockquote>
<p>Now, we only want the Tweet to be sent out when a milestone is closed, but based on the documentation, we should be able to inspect the event payload (which is a JSON file), to see more details about the event, specifically, the <code>action</code> property, which will either be:</p>
<ul>
<li>created</li>
<li>closed</li>
<li>opened</li>
<li>edited</li>
<li>deleted</li>
</ul>
<h2 id="parsing-the-json-file">Parsing the JSON file</h2>
<p>When it comes to parsing JSON files in .NET, the obvious choice is to use <a href="https://www.nuget.org/packages/Newtonsoft.Json/">Newtonsoft.Json</a>.  And in terms of Cake, a community member, <a href="https://github.com/redth">redth</a> has already done the work of creating a Cake Addin (<a href="https://www.nuget.org/packages/Cake.Json/">Cake.Json</a>) to make this incredibly simple.  Parsing a JSON file is as simple as:</p>
<pre><code class="language-csharp">var json = ParseJsonFromFile(&quot;&lt;path to JSON file&gt;&quot;);
</code></pre>
<h2 id="sending-a-tweet">Sending a Tweet</h2>
<p>In the same way that parsing a JSON file in Cake is a one-liner, the same is true of sending a Tweet.  Using the <a href="https://www.nuget.org/packages/Cake.Twitter/">Cake.Twitter</a> addin, sending a tweet is as simple as:</p>
<pre><code class="language-csharp">TwitterSendTweet(&quot;oAuthConsumerKey&quot;, &quot;oAuthConsumerSecret&quot;, &quot;accessToken&quot;, &quot;accessTokenSecret&quot;, &quot;The text for the Tweet you want to send&quot;);
</code></pre>
<div class="alert alert-info"><p><strong>NOTE:</strong></p>
<p>In order to get the above keys and tokens, you will need to create a developer account on Twitter.</p>
</div>
<h2 id="event-data">Event data</h2>
<p>Based on the <a href="https://developer.github.com/actions/creating-github-actions/accessing-the-runtime-environment/#environment-variables">documentation</a> GitHub Actions provides an environment variable which contains the path to a file, which has all the JSON payload of the event which triggered the workflow.  By inspecting this environment variable, and reading the contents of the file, we can figure out whether the event was a milestone being closed.</p>
<h2 id="putting-it-all-together">Putting it all together...</h2>
<p>In the previous blog post, we left the workflow of our action triggering off a <code>push</code> event, with a single environment variable and argument.  It was defined as follows:</p>
<pre><code class="language-shell">workflow &quot;New workflow&quot; {
  on = &quot;push&quot;
  resolves = [&quot;cake test&quot;]
}


action &quot;cake test&quot; {
    uses = &quot;gep13/cake-actions/task&#64;master&quot;

    env = {
        CAKE_SCRIPT = &quot;./build.cake&quot;
    }

    args =[&quot;Default&quot;]
}
</code></pre>
<p>To make our workflow trigger on a milestone event, we will need to change the <code>on</code> parameter, and we will also need to add some <a href="https://developer.github.com/actions/creating-workflows/storing-secrets/">secrets</a> to the definition, which will store the Twitter Keys and Tokens, so that we can actually send the Tweet.  After updating, the workflow then looks like the following:</p>
<pre><code class="language-shell">workflow &quot;New workflow&quot; {
  resolves = [&quot;cake test&quot;]
  on = &quot;milestone&quot;
}

action &quot;cake test&quot; {
  uses = &quot;gep13/cake-actions/task&#64;master&quot;
  env = {
    CAKE_SCRIPT = &quot;./build.cake&quot;
  }
  args = [&quot;Default&quot;]
  secrets = [&quot;TWITTER_CONSUMER_KEY&quot;, &quot;TWITTER_CONSUMER_SECRET&quot;, &quot;TWITTER_ACCESS_TOKEN&quot;, &quot;TWITTER_ACCESS_TOKEN_SECRET&quot;]
}
</code></pre>
<p>Which &quot;looks&quot; like the following:</p>
<p><img src="https://gep13wpstorage.blob.core.windows.net/gep13/2018/12/15/workflow-with-secrets.png" class="img-fluid" alt="Workflow with secrets" /></p>
<h2 id="the-cake-script">The Cake Script</h2>
<p>With the workflow defined, now we can turn our attention to the Cake Script itself.  This will need to:</p>
<ul>
<li>Add the Cake.Json and Cake.Twitter addins</li>
<li>Grab the required environment variables</li>
<li>Parse the event JSON file</li>
<li>Inspect the action variable to see if the milestone is closed</li>
<li>Send the tweet if required</li>
</ul>
<p>The end result (which likely needs some additional error checking, but which works for what is trying to be shown here) looks like the following:</p>
<pre><code class="language-csharp">#addin &quot;nuget:https://www.nuget.org/api/v2?package=Cake.Twitter&amp;version=0.9.0&quot;
#addin &quot;nuget:https://www.nuget.org/api/v2?package=Cake.Json&amp;version=3.0.1&quot;

var target = Argument(&quot;target&quot;, &quot;Default&quot;);

Task(&quot;Default&quot;)
  .Does(() =&gt;
{
  var oAuthConsumerKey        = EnvironmentVariable(&quot;TWITTER_CONSUMER_KEY&quot;);
  var oAuthConsumerSecret     = EnvironmentVariable(&quot;TWITTER_CONSUMER_SECRET&quot;);
  var accessToken             = EnvironmentVariable(&quot;TWITTER_ACCESS_TOKEN&quot;);
  var accessTokenSecret       = EnvironmentVariable(&quot;TWITTER_ACCESS_TOKEN_SECRET&quot;);
  var githubEventPath         = EnvironmentVariable(&quot;GITHUB_EVENT_PATH&quot;);

  if(string.IsNullOrEmpty(githubEventPath))
  {
    throw new Exception(&quot;Unable to find GitHub Event Path&quot;);
  }

  try
  {
    var json = ParseJsonFromFile(githubEventPath);

    Information(json);

    JToken value;
    if (json.TryGetValue(&quot;action&quot;, out value))
    {
      Information(value);

      if(value.ToString() == &quot;closed&quot;)
      {
        TwitterSendTweet(oAuthConsumerKey, oAuthConsumerSecret, accessToken, accessTokenSecret, &quot;This tweet was sent as a result of a milestone being closed on a repository, thanks to &#64;gitHub Actions.  Blog post to follow later...&quot;);

        Information(&quot;Tweet sent&quot;);
      }
      else
      {
        Information(&quot;No tweet sent, as milestone wasn't closed&quot;);
      }
    }
  }
  catch(Exception ex)
  {
      Error(&quot;{0}&quot;, ex);
  }
});

RunTarget(target);
</code></pre>
<h2 id="lets-run-it">Let's run it...</h2>
<p>With all of the above checked into my test repository, I went ahead and created a new milestone.  Looking at the logs, I saw the following:</p>
<p><img src="https://gep13wpstorage.blob.core.windows.net/gep13/2018/12/15/milestone-created-event-payload.png" class="img-fluid" alt="Milestone created event payload" /></p>
<p><img src="https://gep13wpstorage.blob.core.windows.net/gep13/2018/12/15/milestone-created-no-tweet.png" class="img-fluid" alt="Milestone created no tweet" /></p>
<p>I then went ahead and closed the milestone.  Checking the logs, I then saw the following:</p>
<p><img src="https://gep13wpstorage.blob.core.windows.net/gep13/2018/12/15/milestone-closed-event-payload.png" class="img-fluid" alt="Milestone closed event payload" /></p>
<p><img src="https://gep13wpstorage.blob.core.windows.net/gep13/2018/12/15/milestone-closed-tweet-sent.png" class="img-fluid" alt="Milestone closed tweet sent" /></p>
<p>Too good to be true...</p>
<p>Checking Twitter, I then saw the following:</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">This tweet was sent as a result of a milestone being closed on a repository, thanks to <a href="https://twitter.com/github?ref_src=twsrc%5Etfw">&#64;gitHub</a> Actions.  Blog post to follow later...</p>&mdash; Gary Ewan Park (&#64;gep13) <a href="https://twitter.com/gep13/status/1073905256164077568?ref_src=twsrc%5Etfw">December 15, 2018</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>I honestly didn't think that this would &quot;just&quot; work the first time, but it did!  I am really starting to like this system, and the integration of Cake means that I have access to a huge library of addins for doing a huge number of things.</p>
<h2 id="doing-more-stuff">Doing more stuff</h2>
<p>This is just one example of what you can do as the result of an event coming from your repository.  At last count, there are <a href="https://github.com/cake-contrib/Home/blob/master/Audit_for_Cake_0.28.0.md">240 different addins for Cake</a> that means that there are lots of &quot;things&quot; that you can do based on these events being triggered.  When it comes to sending out notifications, there are addins for sending messages:</p>
<ul>
<li>to Discord</li>
<li>to Slack</li>
<li>to Gitter</li>
<li>via email</li>
<li>via SendGrid</li>
<li>the list goes on</li>
</ul>
<p>I would encourage you to take a look at the list of addins, and have a think about the actions that you can add to your repository.</p>
<h2 id="after-thoughts">After thoughts</h2>
<p>After doing the above, I found the <a href="https://github.com/actions/bin/tree/master/filter">following</a> which I &quot;think&quot; I would be able to use to filter the milestone event to only trigger on closed events, but I haven't yet tested to see if this would be possible.  Part of me quite likes containing all the logic in the Cake script, but I guess there is a higher overhead to pay to use the Docker container for Cake if it isn't actually required.  Something to look into for future tests.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'gep13'; // required: replace example with your forum shortname
    var disqus_identifier = 'http://www.gep13.co.uk/blog/using-cake-github-action' + 'S/';
    var disqus_title = 'Using Cake GitHub Action';
    var disqus_url = 'http://www.gep13.co.uk/blog/using-cake-github-action' + '/';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
        <div class="row">
                <div class="col-md-12">
                <ul class="list-inline text-center">
                        <li>
                        <a href="https://twitter.com/gep13">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                        <li>
                        <a href="https://github.com/gep13">
                                <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                        </a>
                        </li>
                </ul>
                <p class="copyright text-muted">
                        Copyright © 2019 by Gary Ewan Park. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way. This work is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                        <br />
                        <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        <br />
                        <a href="https://github.com/gep13/gep13.github.io"><i class="fa fa-github"></i> This Site on GitHub</a> | <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
                </p>
                </div>
        </div>
</div>
                </footer> 

                <script type="text/javascript" src="/assets/js/google.js"></script>
<script type="text/javascript" src="/assets/js/anchor.min.js"></script>
<script type="text/javascript" src="/assets/js/clipboard.min.js"></script>
<script type="text/javascript" src="/assets/js/anchor.js"></script>

                <script>hljs.initHighlightingOnLoad();</script>

                        <script type="text/javascript">                
                                // Header background                        
                                var colors = Please.make_color({
                                        colors_returned: 3,
                                        saturation: .6
                                });
                                var t = new Trianglify({
                                        x_gradient: colors,
                                        y_gradient: ["#FFFFFF"]
                                });
                                var header = document.getElementById("intro-header");
                                var pattern = t.generate(header.clientWidth, header.clientHeight);
                                header.setAttribute('style', 'background-image: ' + pattern.dataUrl);                        
                        </script>

                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>

